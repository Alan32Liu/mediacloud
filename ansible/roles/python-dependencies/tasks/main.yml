---

- name: Initialize Virtualenvwrapper
  command: "bash /usr/local/bin/virtualenvwrapper.sh"
  args:
    creates: "{{ ansible_env.HOME }}/.virtualenvs/initialize"
  environment:
    VIRTUALENVWRAPPER_PYTHON: "python{{ python_version }}"
  tags:
    - python-dependencies

- name: Install Media Cloud Python requirements
  pip:
    name: "{{ item.name }}"
    version: "{{ item.version }}"
    virtualenv: "{{ ansible_env.HOME }}/.virtualenvs/mediacloud/"
    virtualenv_python: "python{{ python_version }}"
  with_items: "{{ python_dependencies }}"
  tags:
    - python-dependencies

- name: Set path to virtualenv's site-packages
  set_fact:
    virtualenv_site_packages_path: "{{ ansible_env.HOME }}/.virtualenvs/mediacloud/lib/python{{ python_version }}/site-packages/"
  tags:
    - python-dependencies

- name: Test if virtualenv's site-packages directory exists
  stat:
    path: "{{ virtualenv_site_packages_path }}"
  register: virtualenv_site_packages_path_stat
  tags:
    - python-dependencies

- name: Ensure that virtualenv's site-packages directory exists
  assert:
    that:
      - "virtualenv_site_packages_path_stat.stat.isdir is defined and virtualenv_site_packages_path_stat.stat.isdir"
  tags:
    - python-dependencies

- name: Add path to mediacloud/ to the .pth file under virtualenv's site-packages directory
  lineinfile:
    dest: "{{ virtualenv_site_packages_path }}/mediacloud.pth"
    regexp: '.*?mediacloud.*?'
    line: "{{ mediacloud_root }}/mediacloud/"
    create: true
    state: present
  tags:
    - python-dependencies
